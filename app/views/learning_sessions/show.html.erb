<div class="max-w-3xl mx-auto">
  <%# Passage section %>
  <section class="mb-10">
    <div class="mb-4">
      <h1 class="page-title mb-3"><%= @passage.title %></h1>
      <div class="flex items-center gap-2">
        <span class="badge bg-primary-50 text-primary-700"><%= @passage.genre %></span>
        <span class="badge bg-ink-100 text-ink-500">난이도 <%= @passage.difficulty %></span>
      </div>
    </div>
    <div class="card-flat p-5 sm:p-7 leading-[1.9] whitespace-pre-wrap text-sm sm:text-base text-ink-800">
      <%= @passage.content %>
    </div>
  </section>

  <%# Base questions %>
  <section class="mb-10">
    <h2 class="section-title mb-5">기초 질문</h2>
    <div class="space-y-4">
      <% @base_questions.each do |bq| %>
        <div class="card p-4 sm:p-5">
          <div class="flex items-start gap-3 mb-3">
            <% bloom_badge_colors = {
              "remember" => "bg-ink-100 text-ink-600",
              "understand" => "bg-primary-50 text-primary-700",
              "apply" => "bg-sage-50 text-sage-600",
              "analyze" => "bg-purple-50 text-purple-700",
              "evaluate" => "bg-accent-50 text-accent-600",
              "create_level" => "bg-warm-50 text-warm-600"
            } %>
            <span class="badge <%= bloom_badge_colors[bq.bloom_level] || 'bg-ink-100 text-ink-600' %> shrink-0"><%= bq.bloom_level %></span>
            <p class="font-medium text-ink-800 text-sm sm:text-base"><%= bq.content %></p>
          </div>
          <% existing = @responses.find { |r| r.base_question_id == bq.id } %>
          <% if existing %>
            <div class="bg-sage-50 p-3 rounded-lg text-sm sm:text-base text-ink-700">
              <%= existing.content %>
            </div>
          <% else %>
            <%= form_with(model: [@session, Response.new], class: "mt-2") do |f| %>
              <%= f.hidden_field :base_question_id, value: bq.id %>
              <%= f.text_area :content, placeholder: "답변을 작성하세요...", rows: 2, class: "input-field" %>
              <div class="mt-2">
                <%= f.submit "답변 제출", class: "btn-primary text-sm cursor-pointer" %>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </section>

  <%# Student questions (after base completed) %>
  <% if @session.base_completed? || @session.questioning? || @session.dialogue_active? || @session.completed? %>
    <section class="mb-10">
      <h2 class="section-title mb-2">나만의 발문 만들기</h2>
      <p class="text-sm text-ink-400 mb-5 pl-3.5">이 지문을 읽고 떠오르는 질문을 만들어보세요.</p>

      <div class="space-y-5">
        <% @student_questions.each do |sq| %>
          <div class="card-flat border-l-3 border-accent-500 p-4 sm:p-5 bg-accent-50/30">
            <div class="flex items-start justify-between gap-3 mb-2">
              <p class="font-semibold text-ink-900 text-sm sm:text-base"><%= sq.content %></p>
              <% if sq.bloom_level %>
                <span class="badge bg-accent-100 text-accent-600 shrink-0">
                  <%= sq.bloom_level %>
                </span>
              <% end %>
            </div>

            <%# AI dialogue - chat bubble style %>
            <% if sq.ai_dialogues.any? %>
              <div class="mt-4 space-y-2.5" id="dialogue">
                <% sq.ai_dialogues.each do |d| %>
                  <% if d.ai_prompt? %>
                    <div class="flex items-start gap-2.5">
                      <span class="shrink-0 w-7 h-7 rounded-md bg-ink-200 flex items-center justify-center text-[10px] font-bold text-ink-600">AI</span>
                      <div class="bg-white border border-ink-200 rounded-lg rounded-tl-sm p-3 text-sm text-ink-700 max-w-[85%]">
                        <%= d.content %>
                      </div>
                    </div>
                  <% else %>
                    <div class="flex items-start gap-2.5 justify-end">
                      <div class="bg-primary-50 border border-primary-100 rounded-lg rounded-tr-sm p-3 text-sm text-ink-700 max-w-[85%]">
                        <%= d.content %>
                      </div>
                      <span class="shrink-0 w-7 h-7 rounded-md bg-primary-100 flex items-center justify-center text-[10px] font-bold text-primary-700">나</span>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>

            <%# Continue dialogue %>
            <% if sq.ai_dialogues.size < 6 %>
              <%= form_with(url: learning_session_dialogues_path(@session), class: "mt-4") do |f| %>
                <%= f.hidden_field "dialogue[student_question_id]", value: sq.id %>
                <%= f.text_area "dialogue[content]", placeholder: "생각을 이어서 써보세요...", rows: 2, class: "input-field" %>
                <div class="mt-2">
                  <%= f.submit "대화 이어가기", class: "btn-secondary text-sm cursor-pointer" %>
                </div>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# New question form %>
      <div class="card-flat p-5 mt-6">
        <%= form_with(model: [@session, StudentQuestion.new]) do |f| %>
          <%= f.text_area :content, placeholder: "새로운 질문을 만들어보세요...", rows: 2, class: "input-field" %>
          <div class="mt-3">
            <%= f.submit "발문 제출", class: "btn-primary w-full sm:w-auto cursor-pointer" %>
          </div>
        <% end %>
      </div>
    </section>
  <% end %>

  <%# Complete session %>
  <% if @session.dialogue_active? && @student_questions.any? %>
    <div class="text-center py-4">
      <%= button_to "학습 완료하기", complete_learning_session_path(@session),
          method: :post, class: "btn-primary btn-lg w-full sm:w-auto cursor-pointer" %>
    </div>
  <% end %>

  <%# Session summary %>
  <% if @session.completed? && @session.session_summary %>
    <section class="mt-10">
      <div class="card-flat p-6 sm:p-8 bg-warm-50">
        <h2 class="section-title mb-4">학습 요약</h2>
        <p class="text-sm sm:text-base text-ink-700 leading-relaxed mb-5"><%= @session.session_summary.summary %></p>
        <% if @session.session_summary.highlight_question.present? %>
          <div class="highlight-quote">
            <p class="text-sm sm:text-base leading-relaxed">
              "<%= @session.session_summary.highlight_question %>"
            </p>
          </div>
        <% end %>
      </div>
    </section>
  <% end %>
</div>
