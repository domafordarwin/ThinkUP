<div class="max-w-4xl mx-auto">
  <h1 class="page-title mb-8">내 성장 대시보드</h1>

  <%# Stats cards %>
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-10">
    <div class="stat-card">
      <div class="absolute top-0 left-0 right-0 h-[3px] bg-primary-600"></div>
      <p class="text-3xl font-extrabold text-primary-600 mb-1 tracking-tight"><%= @stats[:total_sessions] %></p>
      <p class="text-sm text-ink-400 font-medium">완료한 학습</p>
    </div>
    <div class="stat-card">
      <div class="absolute top-0 left-0 right-0 h-[3px] bg-accent-500"></div>
      <p class="text-3xl font-extrabold text-accent-600 mb-1 tracking-tight"><%= @stats[:bloom_distribution].values.sum %></p>
      <p class="text-sm text-ink-400 font-medium">생성한 발문</p>
    </div>
    <div class="stat-card">
      <div class="absolute top-0 left-0 right-0 h-[3px] bg-sage-500"></div>
      <% avg = @stats[:competency_averages].values %>
      <p class="text-3xl font-extrabold text-sage-600 mb-1 tracking-tight"><%= avg.any? ? (avg.sum / avg.size).round(1) : "-" %></p>
      <p class="text-sm text-ink-400 font-medium">평균 역량 점수</p>
    </div>
  </div>

  <%# Bloom distribution %>
  <section class="mb-10">
    <h2 class="section-title mb-5">발문 수준 분포 (블룸의 택소노미)</h2>
    <div class="card-flat p-5 sm:p-6">
      <% bloom_levels = %w[remember understand apply analyze evaluate create_level] %>
      <% bloom_labels = { "remember" => "기억", "understand" => "이해", "apply" => "적용", "analyze" => "분석", "evaluate" => "평가", "create_level" => "창조" } %>
      <% bloom_colors = { "remember" => "bg-ink-300", "understand" => "bg-primary-500", "apply" => "bg-sage-500", "analyze" => "bg-purple-500", "evaluate" => "bg-accent-500", "create_level" => "bg-warm-500" } %>
      <% max_count = [@stats[:bloom_distribution].values.max || 1, 1].max %>
      <div class="space-y-3">
        <% bloom_levels.each do |level| %>
          <% count = @stats[:bloom_distribution][level] || 0 %>
          <div class="flex items-center gap-3">
            <span class="w-14 sm:w-16 text-sm text-ink-600 font-semibold text-right"><%= bloom_labels[level] %></span>
            <div class="flex-1">
              <div class="progress-bar h-7">
                <div class="progress-bar-fill <%= bloom_colors[level] %> flex items-center justify-end pr-2.5"
                     style="width: <%= [(count.to_f / max_count * 100).round, 8].max %>%">
                  <span class="text-xs text-white font-semibold"><%= count %></span>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <%# Competency scores %>
  <section class="mb-10">
    <h2 class="section-title mb-5">3대 역량 점수</h2>
    <% competency_labels = { "comprehension" => "이해력", "aesthetic" => "심미적 감수성", "communication" => "의사소통 능력" } %>
    <% competency_colors = { "comprehension" => "bg-primary-500", "aesthetic" => "bg-warm-500", "communication" => "bg-sage-500" } %>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <% competency_labels.each do |key, label| %>
        <div class="stat-card">
          <p class="text-2xl font-extrabold text-ink-900 mb-1 tracking-tight">
            <%= @stats[:competency_averages][key] || "-" %>
          </p>
          <p class="text-sm text-ink-400 font-medium mb-3"><%= label %></p>
          <% score = @stats[:competency_averages][key] || 0 %>
          <div class="progress-bar">
            <div class="progress-bar-fill <%= competency_colors[key] %>" style="width: <%= score.to_f / 5 * 100 %>%"></div>
          </div>
        </div>
      <% end %>
    </div>
  </section>

  <%# Highlight question %>
  <% if @stats[:highlight_question].present? %>
    <section class="mb-10">
      <h2 class="section-title mb-5">이번 주 최고 발문</h2>
      <div class="card-flat p-6 bg-warm-50">
        <div class="highlight-quote">
          <p class="text-base sm:text-lg leading-relaxed">
            "<%= @stats[:highlight_question] %>"
          </p>
        </div>
      </div>
    </section>
  <% end %>

  <%# Recent sessions %>
  <section>
    <h2 class="section-title mb-5">최근 학습 기록</h2>
    <div class="space-y-3">
      <% @stats[:recent_sessions].each do |session| %>
        <div class="card p-4 sm:p-5 flex justify-between items-center">
          <div>
            <p class="font-semibold text-ink-900 text-sm sm:text-base"><%= session.passage.title %></p>
            <p class="text-xs sm:text-sm text-ink-400 mt-1"><%= session.created_at.strftime("%Y-%m-%d") %></p>
          </div>
          <%= link_to "보기", learning_session_path(session), class: "btn-secondary text-sm" %>
        </div>
      <% end %>
    </div>
  </section>
</div>
